<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Stretching Routine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .timer-circle {
            transform: rotate(-90deg);
        }
        #player-container, #preview-player-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .video-select-btn {
            background-color: #4B5563; /* gray-600 */
            transition: background-color 0.2s;
        }
        .video-select-btn.active {
            background-color: #06B6D4; /* cyan-500 */
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 text-center">

        <!-- Header -->
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-cyan-400">Daily Stretch</h1>
            <p id="routine-date" class="text-gray-400">Your routine for today</p>
        </header>

        <!-- Initial State / Welcome Screen -->
        <div id="welcome-screen">
            <div class="bg-gray-700 p-6 rounded-xl mb-6">
                <h2 class="text-xl font-semibold mb-2">Today's Focus</h2>
                <p class="text-gray-300">A quick and effective routine for <span id="selected-mode-display" class="font-semibold text-cyan-300">Random</span> selection.</p>
            </div>

            <!-- Mode Selection Buttons -->
            <div class="mb-6 p-4 bg-gray-700 rounded-xl">
                <h3 class="text-lg font-semibold mb-3">Choose Your Routine</h3>
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <button class="mode-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105" data-mode="High Kicks">High Kicks</button>
                    <button class="mode-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105" data-mode="Day to day">Day to day</button>
                    <button class="mode-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105" data-mode="Running">Running</button>
                    <button class="mode-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105" data-mode="Random">Random</button>
                </div>
                <p class="text-gray-400 text-sm mb-3">Selected Mode: <span class="font-semibold text-cyan-300" id="current-selected-mode-text">Random</span></p>

                <h3 class="text-lg font-semibold mb-3">Routine Settings</h3>
                <div class="flex flex-col space-y-3">
                    <!-- Individual Exercise Selection -->
                    <div id="individual-exercise-selection-container">
                        <label for="exercise-select" class="block text-gray-300 text-sm font-medium mb-1">Or Select an Individual Exercise:</label>
                        <select id="exercise-select" class="w-full p-2 rounded-md bg-gray-900 text-white border border-gray-600 focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50">
                            <option value="">-- Select an exercise --</option>
                        </select>
                    </div>
                    <div>
                        <label for="num-stretches-input" class="block text-gray-300 text-sm font-medium mb-1">Number of Stretches:</label>
                        <input type="number" id="num-stretches-input" value="5" min="1" max="30" class="w-full p-2 rounded-md bg-gray-900 text-white border border-gray-600 focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="stretch-duration-input" class="block text-gray-300 text-sm font-medium mb-1">Stretch Duration (seconds):</label>
                        <input type="number" id="stretch-duration-input" value="60" min="10" max="180" class="w-full p-2 rounded-md bg-gray-900 text-white border border-gray-600 focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50">
                    </div>
                    <div>
                        <label for="rest-duration-input" class="block text-gray-300 text-sm font-medium mb-1">Rest Duration (seconds):</label>
                        <input type="number" id="rest-duration-input" value="10" min="5" max="60" class="w-full p-2 rounded-md bg-gray-900 text-white border border-gray-600 focus:border-cyan-500 focus:ring focus:ring-cyan-500 focus:ring-opacity-50">
                    </div>
                </div>
            </div>

            <!-- Individual Exercise Preview Area -->
            <div id="individual-exercise-preview" class="relative w-full aspect-video bg-gray-900 rounded-lg overflow-hidden mb-4 shadow-lg hidden">
                <div id="preview-player-container">
                    <div id="preview-player"></div>
                </div>
                <h4 id="preview-name" class="absolute bottom-0 left-0 right-0 bg-gray-900 bg-opacity-75 text-white text-lg font-semibold py-2 px-4"></h4>
                <!-- Video Selector for Preview -->
                <div id="video-selector-preview" class="absolute bottom-10 left-0 right-0 flex justify-center space-x-2 p-2"></div>
            </div>

            <!-- Unverified Exercises List -->
            <div id="unverified-exercises-list" class="bg-gray-700 p-4 rounded-xl mb-6 text-left hidden">
                <h3 class="text-lg font-semibold mb-3 text-red-300">Exercises to Fix:</h3>
                <ul id="fix-list" class="list-disc list-inside text-gray-300"></ul>
            </div>


            <button id="start-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-4 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 shadow-lg">
                Start Routine
            </button>
            <div class="mt-4 text-sm text-gray-500">
                <p>A new routine is generated every day!</p>
            </div>
        </div>

        <!-- Stretching Session Screen -->
        <div id="session-screen" class="hidden">
            <!-- Media Container -->
            <div class="relative w-full aspect-video bg-gray-900 rounded-lg overflow-hidden mb-4 shadow-lg">
                <div id="player-container">
                    <div id="player"></div>
                </div>
                 <img id="rest-image-container" src="https://placehold.co/400x225/1F2937/white?text=REST" alt="Resting" class="w-full h-full object-contain hidden">
            </div>

            <!-- Video Selector for Session -->
            <div id="video-selector-session" class="flex justify-center items-center space-x-2 mb-4"></div>

            <!-- Stretch Info -->
            <h2 id="stretch-name" class="text-2xl font-bold mb-2"></h2>
            <p id="progress-text" class="text-gray-400 mb-4"></p>

            <!-- Timer -->
            <div class="relative w-40 h-40 mx-auto mb-4">
                <svg class="w-full h-full" viewBox="0 0 100 100">
                    <circle class="text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                    <circle id="timer-progress" class="text-cyan-400 timer-circle" stroke-width="8"
                            stroke-dasharray="283"
                            stroke-dashoffset="283"
                            stroke-linecap="round"
                            stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                </svg>
                <div id="timer-display" class="absolute inset-0 flex flex-col items-center justify-center">
                    <span id="timer-text" class="text-4xl font-bold"></span>
                    <span id="timer-label" class="text-sm text-gray-400"></span>
                </div>
            </div>
            
            <div class="flex space-x-4">
                <button id="pause-resume-btn" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Pause</button>
                <button id="end-btn" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">End Routine</button>
            </div>
        </div>

        <!-- Completion Screen -->
        <div id="completion-screen" class="hidden">
            <div class="bg-gray-700 p-8 rounded-xl text-center">
                <h2 class="text-3xl font-bold text-cyan-400 mb-4">Great Job!</h2>
                <p class="text-gray-300 mb-6">You've completed your daily stretch. See you tomorrow for a new routine!</p>
                <button id="restart-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">
                    Do It Again
                </button>
            </div>
        </div>
        
        <!-- Instructions -->
        <div id="instructions" class="mt-8 text-left text-sm text-gray-400 border-t border-gray-700 pt-4">
            <h3 class="font-semibold text-lg mb-2 text-white">How to Use This App</h3>
            <ol class="list-decimal list-inside space-y-2">
                <li>Select your desired routine mode or an individual exercise from the dropdown.</li>
                <li>Adjust the routine settings, then press the <strong class="text-cyan-300">Start Routine</strong> button.</li>
                <li>The exercise video will play automatically.</li>
                <li>If an exercise has multiple videos, buttons like <strong class="text-cyan-300">V1, V2</strong> will appear to let you switch.</li>
                <li>Follow the exercise for the set duration, then rest for the time allotted.</li>
                <li>Press <strong class="text-yellow-400">Pause</strong> if you need a break, and <strong class="text-red-400">End Routine</strong> to stop.</li>
            </ol>
        </div>
    </div>

    <script>
        // --- DATA: Stretches (Video-First with Verified Checkmarks) ---
        const stretches = [
            // Hips
            { name: "Pigeon Pose", videoIds: ["M9VNeCErXq8"], routineTypes: ["Day to day", "High Kicks"], verified: true, multiPart: true, parts: [{ label: "Left Leg", start: 3 }, { label: "Right Leg", start: 30 }] }, // Modified to multi-part
            { name: "Frog Stretch", videoIds: ["0CH1NVeNJbw"], start: 11, routineTypes: ["Day to day", "High Kicks"], verified: true }, // Video added, verified
            { name: "Butterfly Stretch", videoIds: ["N-xrg7jYVW0"], start: 4, routineTypes: ["Day to day", "High Kicks"], verified: true },
            { name: "Seated Straddle", videoIds: ["uKg1rqo9YrE"], start: 120, routineTypes: ["Day to day", "High Kicks"], verified: true }, // Video added, verified
            { name: "Kneeling Hip Flexor Stretch", videoIds: ["3wthmvKWoOU"], start: 2, routineTypes: ["Day to day", "High Kicks", "Running"], verified: true },
            { name: "Lying Hip Rotations", videoIds: ["EHZJns1bXPM"], start: 0, routineTypes: ["Day to day", "Running"], verified: true }, // Video added, verified
            { name: "90/90 Stretch", videoIds: ["m51AZSXMvEA"], start: 0, routineTypes: ["Day to day", "High Kicks"], verified: true }, // Video added, verified
            { name: "Standing Figure-Four", videoIds: [], routineTypes: ["Day to day", "High Kicks"] }, // Video removed
            { name: "Cossack Squat", videoIds: ["fyAl4o1BGVo"], start: 120, routineTypes: ["Day to day", "High Kicks"], verified: true }, // Video changed, verified
            { name: "Deep Squat Hold", videoIds: ["iQaw0pj6cEQ"], start: 0, routineTypes: ["Day to day", "High Kicks"], verified: true }, // Video added, verified
            { name: "Fire Log Pose", videoIds: [], routineTypes: ["Day to day", "High Kicks"] }, // Video removed
            { name: "Happy Baby Pose", videoIds: ["z-BjiGQZe4s"], start: 2, routineTypes: ["Day to day"], verified: true }, // Added video, verified
            
            // Ankles
            { name: "Ankle Circles", videoIds: [], routineTypes: ["Day to day", "Running"] }, // No verified videos
            { name: "Heel/Toe Walks", videoIds: ["WwFFa-VHz3o"], start: 0, routineTypes: ["Day to day", "Running"], verified: true }, // Video added, verified
            { name: "Kneeling Ankle Stretch", videoIds: [], routineTypes: ["Day to day", "Running"] }, // Video removed
            { name: "Standing Calf Stretch", videoIds: ["1qlN5EXFUNo"], start: 0, routineTypes: ["Day to day", "Running"], verified: true }, // Video added, verified
            { name: "Soleus Stretch", videoIds: ["XWY9swAP7-c"], start: 0, routineTypes: ["Day to day", "Running"], verified: true }, // Video added, verified
            { name: "Ankle Dorsiflexion Stretch", videoIds: [], routineTypes: ["Day to day", "Running"] }, // No verified videos
            { name: "Ankle Inversion/Eversion", videoIds: [], routineTypes: ["Day to day", "Running"] }, // No verified videos
            { name: "Lunging Ankle Stretch", videoIds: [], routineTypes: ["Day to day", "Running"] }, // Video removed
            { name: "Alphabet Ankles", videoIds: [], routineTypes: ["Day to day", "Running"] }, // No verified videos
            { name: "Seated Ankle Stretch", videoIds: [], routineTypes: ["Day to day", "Running"] }, // Video removed

            // Shoulders
            { name: "Arm Circles", videoIds: ["Lha66p0ZXUc"], routineTypes: ["Day to day"], verified: true },
            { name: "Cross-Body Arm Stretch", videoIds: ["2quJjVCT7AY"], start: 17, routineTypes: ["Day to day"], verified: true }, // Added video, verified
            { name: "Overhead Triceps Stretch", videoIds: ["NQzLqpHLyuI"], start: 2, routineTypes: ["Day to day"], verified: true }, // Added video, verified
            { name: "Doorway Chest Stretch", videoIds: ["NS64IgKUyeY"], start: 3, routineTypes: ["Day to day"], verified: true }, // Added video, verified
            { name: "Thread the Needle", videoIds: ["2CGqyWvxP-g"], start: 0, routineTypes: ["Day to day"], verified: true }, // Added video, verified

            // Neck
            { name: "Neck Tilts", videoIds: ["0jzWXtnipPY"], start: 0, routineTypes: ["Day to day"], verified: true }, // Added video, verified
            { name: "Neck Rotations", videoIds: [], routineTypes: ["Day to day"] }, // No verified videos
            { name: "Chin Tucks", videoIds: [], routineTypes: ["Day to day"] }, // No verified videos
            { name: "Ear to Shoulder Stretch", videoIds: [], routineTypes: ["Day to day"] }, // Video removed

            // Back
            { name: "Cat-Cow Pose", videoIds: ["w_UKcI1Ftn8"], start: 0, routineTypes: ["Day to day"], verified: true }, // Renamed, added video, verified
            { name: "Child's Pose", videoIds: ["DMwRPGMPB10"], start: 0, routineTypes: ["Day to day"], verified: true }, // Added video, verified
            { name: "Spinal Twist (Seated)", videoIds: ["4YlCtaTdtgA"], start: 0, routineTypes: ["Day to day"], verified: true }, // Added video, verified
            { name: "Supermans", videoIds: ["pGeaBXLwDtw"], start: 3, routineTypes: ["Day to day"], verified: true },
            { name: "Cobra Stretch", videoIds: ["9Z7IO95Np2g"], start: 0, routineTypes: ["Day to day"], verified: true }, // Added video, verified
            { name: "SEATED ABS CIRCLES", videoIds: ["GflQ_ymx9Nw"], start: 3, routineTypes: ["Day to day"], verified: true },

            // Legs
            { name: "Standing Hamstring Stretch", videoIds: ["fsZebJN-gqk"], start: 0, routineTypes: ["Day to day", "High Kicks", "Running"], verified: true }, // Video added, verified
            { name: "EASY KNEELING HAMSTRING STRETCH", videoIds: ["TxuyL_xwFIE"], start: 4, routineTypes: ["Day to day", "Running"], verified: true },
            { name: "SITTING HAMSTRING STRETCH", videoIds: ["TfMyFKmTpvg"], start: 2, routineTypes: ["Day to day", "Running"], verified: true }, // Updated video, verified
            { name: "Quad Stretch (Standing)", videoIds: ["UTA-6h17Zdo"], start: 0, routineTypes: ["Day to day", "High Kicks", "Running"], verified: true }, // Video added, verified
            { name: "Glute Bridge", videoId: "8bbE64NuDTU", start: 86, routineTypes: ["Day to day", "High Kicks", "Running"], verified: true },
            { name: "Forward Fold", videoIds: ["MKyJujOc2vo"], start: 0, routineTypes: ["Day to day", "Running"], verified: true }, // Video added, verified
            { name: "Pancake Stretch", videoIds: [], routineTypes: ["Day to day", "High Kicks"] }, // Video removed
            { name: "BULGARIAN SPLIT SQUAT", videoIds: ["Brh1SHAkknI"], start: 4, routineTypes: ["High Kicks", "Running"], verified: true },
        ];
        
        // --- DOM Elements ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const sessionScreen = document.getElementById('session-screen');
        const completionScreen = document.getElementById('completion-screen');
        const startBtn = document.getElementById('start-btn');
        const pauseResumeBtn = document.getElementById('pause-resume-btn');
        const endBtn = document.getElementById('end-btn');
        const restartBtn = document.getElementById('restart-btn');
        const stretchNameEl = document.getElementById('stretch-name');
        const progressTextEl = document.getElementById('progress-text');
        const timerTextEl = document.getElementById('timer-text');
        const timerLabelEl = document.getElementById('timer-label');
        const timerProgressEl = document.getElementById('timer-progress');
        const routineDateEl = document.getElementById('routine-date');
        const playerContainer = document.getElementById('player-container');
        const restImageContainer = document.getElementById('rest-image-container');
        const numStretchesInput = document.getElementById('num-stretches-input');
        const stretchDurationInput = document.getElementById('stretch-duration-input');
        const restDurationInput = document.getElementById('rest-duration-input');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const selectedModeDisplay = document.getElementById('selected-mode-display');
        const currentSelectedModeText = document.getElementById('current-selected-mode-text');
        const exerciseSelect = document.getElementById('exercise-select');
        const individualExercisePreview = document.getElementById('individual-exercise-preview');
        const previewName = document.getElementById('preview-name');
        const previewPlayerContainer = document.getElementById('preview-player-container');
        const videoSelectorSession = document.getElementById('video-selector-session');
        const videoSelectorPreview = document.getElementById('video-selector-preview');
        const individualExerciseSelectionContainer = document.getElementById('individual-exercise-selection-container');
        const unverifiedExercisesListContainer = document.getElementById('unverified-exercises-list');
        const fixList = document.getElementById('fix-list');


        // --- App State ---
        let dailyRoutine = [];
        let currentStretchIndex = 0;
        let timerInterval;
        let timeLeft = 0;
        let isPaused = false;
        let isResting = false;
        let STRETCH_DURATION = 60;
        let REST_DURATION = 10;
        let TOTAL_STRETCHES = 5;
        let SELECTED_MODE = 'Random';
        let IS_INDIVIDUAL_PREVIEW_MODE = false;
        let currentPartIndex = 0; // New: To track parts of a multi-part exercise

        // --- YouTube Players ---
        let sessionPlayer;
        let previewPlayer;
        let isSessionPlayerReady = false;
        let isPreviewPlayerReady = false;

        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api"; // Correct YouTube Iframe API URL
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            sessionPlayer = new YT.Player('player', {
                height: '100%', width: '100%',
                playerVars: { 'playsinline': 1, 'controls': 0, 'showinfo': 0, 'rel': 0, 'loop': 1, 'mute': 0, 'autoplay': 1 },
                events: { 'onReady': onSessionPlayerReady, 'onStateChange': onSessionPlayerStateChange }
            });
            previewPlayer = new YT.Player('preview-player', {
                height: '100%', width: '100%',
                playerVars: { 'playsinline': 1, 'controls': 0, 'showinfo': 0, 'rel': 0, 'loop': 1, 'mute': 0, 'autoplay': 1 },
                events: { 'onReady': () => isPreviewPlayerReady = true, 'onStateChange': onPreviewPlayerStateChange }
            });
        }
        
        function onSessionPlayerReady(event) {
            isSessionPlayerReady = true;
            // The video will be loaded and played when startNextStretch is called
        }

        function onSessionPlayerStateChange(event) { if (event.data == YT.PlayerState.ENDED) { sessionPlayer.seekTo(0); sessionPlayer.playVideo(); } }
        function onPreviewPlayerStateChange(event) { if (event.data == YT.PlayerState.ENDED) { previewPlayer.seekTo(0); previewPlayer.playVideo(); } }
        
        // --- Core Logic ---
        function getVideoIdForStretch(stretch, index = 0, partIndex = 0) {
            if (stretch.multiPart && stretch.parts && stretch.parts.length > 0) {
                return {
                    videoId: stretch.videoIds[0], // Assuming multi-part uses the first video ID from videoIds
                    start: stretch.parts[partIndex].start || 0
                };
            }
            // Check for single videoId with verified flag first
            if (stretch.videoId && stretch.verified) {
                return {
                    videoId: stretch.videoId,
                    start: stretch.start || 0
                };
            }
            // Then check for videoIds array with verified flag
            if (stretch.videoIds && stretch.videoIds.length > 0 && stretch.verified) {
                return {
                    videoId: stretch.videoIds[index] || stretch.videoIds[0],
                    start: stretch.start || 0
                };
            }
            return { videoId: null, start: 0 }; // No video available or not verified
        }


        function getDayOfYear() {
            const now = new Date();
            const start = new Date(now.getFullYear(), 0, 0);
            const diff = now - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay);
        }

        function seededRandom(seed) {
            let x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        function shuffleArray(array, seed) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(seededRandom(seed + i) * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function generateDailyRoutine() {
            const day = getDayOfYear();
            let filteredStretches = stretches.filter(stretch => {
                // For multi-part exercises, consider them as having a video if videoIds is present and verified
                const hasVideo = (stretch.multiPart && stretch.videoIds && stretch.videoIds.length > 0 && stretch.verified) ||
                                 (stretch.videoId && stretch.verified) ||
                                 (stretch.videoIds && stretch.videoIds.length > 0 && stretch.verified);
                if (!hasVideo) return false; // Exclude stretches without a verified video
                return SELECTED_MODE === 'Random' || (stretch.routineTypes && stretch.routineTypes.includes(SELECTED_MODE));
            });
            const shuffledStretches = shuffleArray(filteredStretches, day);
            dailyRoutine = shuffledStretches.slice(0, TOTAL_STRETCHES);

            if (dailyRoutine.length === 0 && SELECTED_MODE !== 'Random') {
                showCustomMessage(`No stretches with verified videos found for "${SELECTED_MODE}" routine. Trying "Random" instead.`);
                SELECTED_MODE = 'Random';
                currentSelectedModeText.textContent = 'Random';
                selectedModeDisplay.textContent = 'Random';
                generateDailyRoutine();
            } else if (dailyRoutine.length === 0 && SELECTED_MODE === 'Random') {
                showCustomMessage('No stretches with verified videos available to generate a random routine.');
            }
        }

        function startRoutine() {
            individualExercisePreview.classList.add('hidden');
            if (isPreviewPlayerReady) previewPlayer.stopVideo();
            IS_INDIVIDUAL_PREVIEW_MODE = false;

            TOTAL_STRETCHES = parseInt(numStretchesInput.value);
            STRETCH_DURATION = parseInt(stretchDurationInput.value);
            REST_DURATION = parseInt(restDurationInput.value);
            currentPartIndex = 0; // Reset part index for new routine

            // If an individual exercise is selected, create a routine with just that exercise
            const selectedExerciseName = exerciseSelect.value;
            if (selectedExerciseName && selectedExerciseName !== "") {
                const selectedStretch = stretches.find(s => s.name === selectedExerciseName);
                const hasVerifiedVideo = (selectedStretch.multiPart && selectedStretch.videoIds && selectedStretch.videoIds.length > 0 && selectedStretch.verified) ||
                                         (selectedStretch.videoId && selectedStretch.verified) ||
                                         (selectedStretch.videoIds && selectedStretch.videoIds.length > 0 && selectedStretch.verified);

                if (selectedStretch && hasVerifiedVideo) {
                    dailyRoutine = [selectedStretch];
                    TOTAL_STRETCHES = 1; // Override total stretches for individual exercise
                } else {
                    showCustomMessage(`The selected exercise "${selectedExerciseName}" does not have a verified video and cannot be started.`);
                    return; 
                }
            } else {
                generateDailyRoutine();
            }
            
            if (dailyRoutine.length === 0) {
                showCustomMessage("No stretches available for the selected criteria. Please adjust your routine settings.");
                return; 
            }

            currentStretchIndex = 0;
            isPaused = false;
            isResting = false;
            welcomeScreen.classList.add('hidden');
            completionScreen.classList.add('hidden');
            sessionScreen.classList.remove('hidden');
            document.getElementById('instructions').classList.add('hidden');
            startNextStretch();
        }

        function startNextStretch() {
            if (currentStretchIndex >= dailyRoutine.length) {
                endRoutine(true);
                return;
            }

            isResting = false;
            playerContainer.classList.remove('hidden');
            restImageContainer.classList.add('hidden');
            
            const currentStretch = dailyRoutine[currentStretchIndex];
            
            // Handle multi-part exercises
            let stretchDisplayName = currentStretch.name;
            let videoDetails;

            if (currentStretch.multiPart && currentStretch.parts && currentStretch.parts.length > 0) {
                const currentPart = currentStretch.parts[currentPartIndex];
                stretchDisplayName = `${currentStretch.name} (${currentPart.label})`;
                videoDetails = getVideoIdForStretch(currentStretch, 0, currentPartIndex); // Pass partIndex
                progressTextEl.textContent = `Stretch ${currentStretchIndex + 1} of ${TOTAL_STRETCHES} (Part ${currentPartIndex + 1} of ${currentStretch.parts.length})`;
            } else {
                videoDetails = getVideoIdForStretch(currentStretch);
                progressTextEl.textContent = `Stretch ${currentStretchIndex + 1} of ${TOTAL_STRETCHES}`;
            }

            stretchNameEl.textContent = stretchDisplayName;
            timerLabelEl.textContent = "Stretch";
            pauseResumeBtn.textContent = "Pause";

            if (isSessionPlayerReady && videoDetails.videoId) {
                sessionPlayer.loadVideoById({ videoId: videoDetails.videoId, startSeconds: videoDetails.start });
            } else if (!videoDetails.videoId) {
                showCustomMessage(`No video found for ${stretchDisplayName}. Skipping.`);
                handlePartCompletion(); // Use handlePartCompletion to move to next part/stretch
                return;
            }
            
            updateVideoSelectionUI(videoSelectorSession, currentStretch, sessionPlayer);
            startTimer(STRETCH_DURATION, handlePartCompletion); // Always call handlePartCompletion
        }

        function handlePartCompletion() {
            const currentStretch = dailyRoutine[currentStretchIndex];
            if (currentStretch.multiPart && currentPartIndex < currentStretch.parts.length - 1) {
                currentPartIndex++;
                startNextStretch(); // Move to the next part of the same exercise
            } else {
                // All parts done or not a multi-part exercise
                currentPartIndex = 0; // Reset for the next exercise
                currentStretchIndex++; // Move to the next full exercise
                startRestPeriod();
            }
        }

        function startRestPeriod() {
            if (currentStretchIndex >= dailyRoutine.length) {
                endRoutine(true);
                return;
            }

            isResting = true;
            
            playerContainer.classList.add('hidden');
            restImageContainer.classList.remove('hidden');
            videoSelectorSession.innerHTML = ''; // Clear video selectors during rest

            stretchNameEl.textContent = "Get Ready...";
            progressTextEl.textContent = `Next: ${dailyRoutine[currentStretchIndex].name}`;
            timerLabelEl.textContent = "Rest";
            
            if (isSessionPlayerReady) sessionPlayer.stopVideo();
            
            startTimer(REST_DURATION, startNextStretch);
        }
        
        function updateVideoSelectionUI(container, stretch, player) {
            container.innerHTML = ''; // Clear previous buttons
            // For multi-part exercises, we assume the video is fixed per exercise, not per part.
            // So we use the main videoIds.
            const videos = stretch.videoIds || (stretch.videoId && stretch.verified ? [stretch.videoId] : []);

            if (videos.length <= 1) {
                return; // Don't show selector for single or no videos
            }

            videos.forEach((videoId, index) => {
                const button = document.createElement('button');
                button.textContent = `V${index + 1}`;
                button.className = 'video-select-btn text-white font-semibold py-1 px-3 rounded-md text-xs';
                if (index === 0) {
                    button.classList.add('active'); // Activate the first button by default
                }
                
                button.addEventListener('click', () => {
                    container.querySelectorAll('.video-select-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    if (player && typeof player.loadVideoById === 'function') {
                        // For multi-part, switching video should reset to first part
                        if (stretch.multiPart) {
                           sessionPlayer.loadVideoById({ videoId: videoId, startSeconds: stretch.parts[0].start || 0 });
                           currentPartIndex = 0; // Reset part index if video is manually changed
                           stretchNameEl.textContent = `${stretch.name} (${stretch.parts[0].label})`;
                           progressTextEl.textContent = `Stretch ${currentStretchIndex + 1} of ${TOTAL_STRETCHES} (Part 1 of ${stretch.parts.length})`;
                        } else {
                           player.loadVideoById({ videoId: videoId, startSeconds: stretch.start || 0 });
                        }
                    }
                });
                container.appendChild(button);
            });
        }


        function startTimer(duration, onComplete) {
            clearInterval(timerInterval);
            timeLeft = duration;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                if (isPaused) return;
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    onComplete();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            timerTextEl.textContent = timeLeft;
            const duration = isResting ? REST_DURATION : STRETCH_DURATION;
            const progress = duration > 0 ? timeLeft / duration : 0; 
            const dashOffset = 283 * (1 - progress);
            timerProgressEl.style.strokeDashoffset = dashOffset;
        }
        
        function togglePauseResume() {
            isPaused = !isPaused;
            if (isPaused) {
                pauseResumeBtn.textContent = "Resume";
                pauseResumeBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                pauseResumeBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                if (isSessionPlayerReady) sessionPlayer.pauseVideo();
            } else {
                pauseResumeBtn.textContent = "Pause";
                pauseResumeBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                pauseResumeBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                if (isSessionPlayerReady) sessionPlayer.playVideo();
            }
        }

        function endRoutine(completed = false) {
            clearInterval(timerInterval);
            sessionScreen.classList.add('hidden');
            if (completed) {
                completionScreen.classList.remove('hidden');
            } else {
                welcomeScreen.classList.remove('hidden');
                document.getElementById('instructions').classList.remove('hidden');
            }
            if (isSessionPlayerReady) sessionPlayer.stopVideo();
            if (isPreviewPlayerReady) previewPlayer.stopVideo();
            selectedModeDisplay.textContent = SELECTED_MODE;
            currentSelectedModeText.textContent = SELECTED_MODE;
            exerciseSelect.value = "";
            individualExercisePreview.classList.add('hidden');
            updateUIBasedOnMode(); // Call to update visibility after ending routine
            currentPartIndex = 0; // Reset part index on routine end
        }

        function showCustomMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4';
            messageBox.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl text-center max-w-sm mx-auto">
                    <p class="text-white text-lg mb-4">${message}</p>
                    <button id="message-box-ok" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg">OK</button>
                </div>
            `;
            document.body.appendChild(messageBox);

            document.getElementById('message-box-ok').addEventListener('click', () => {
                document.body.removeChild(messageBox);
            });
        }

        function populateExerciseSelect() {
            exerciseSelect.innerHTML = '<option value="">-- Select an exercise --</option>';
            fixList.innerHTML = ''; // Clear previous fix list

            const unverified = [];
            const exercisesForMode = stretches.filter(stretch => {
                // Determine if the stretch has a verified video.
                const hasVideo = (stretch.multiPart && stretch.videoIds && stretch.videoIds.length > 0 && stretch.verified) ||
                                 (stretch.videoId && stretch.verified) ||
                                 (stretch.videoIds && stretch.videoIds.length > 0 && stretch.verified);
                
                if (!hasVideo) {
                    unverified.push(stretch); // Push the whole stretch object to access its name
                    return false; // Exclude from dropdown if no verified video
                }
                // Include in dropdown if it's for 'Random' mode or matches the selected routine type.
                return SELECTED_MODE === 'Random' || (stretch.routineTypes && stretch.routineTypes.includes(SELECTED_MODE));
            });

            exercisesForMode.forEach(stretch => {
                const option = document.createElement('option');
                option.value = stretch.name;
                // Add checkmark only if the exercise is explicitly marked as verified
                option.textContent = stretch.name + (stretch.verified ? ' ✔️' : '');
                exerciseSelect.appendChild(option);
            });

            if (unverified.length > 0 && SELECTED_MODE !== 'Random') {
                unverifiedExercisesListContainer.classList.remove('hidden');
                unverified.forEach(stretch => {
                    const listItem = document.createElement('li');
                    // Display "No video Available" for exercises without a video
                    listItem.textContent = `${stretch.name} (No video Available)`;
                    fixList.appendChild(listItem);
                });
            } else {
                unverifiedExercisesListContainer.classList.add('hidden');
            }
        }

        function showIndividualExercisePreview(exerciseName) {
            if (exerciseName === "") {
                individualExercisePreview.classList.add('hidden');
                selectedModeDisplay.textContent = SELECTED_MODE;
                IS_INDIVIDUAL_PREVIEW_MODE = false;
                if (isPreviewPlayerReady) previewPlayer.stopVideo();
                return;
            }

            IS_INDIVIDUAL_PREVIEW_MODE = true;
            const selectedStretch = stretches.find(s => s.name === exerciseName);
            if (selectedStretch) {
                const videoDetails = getVideoIdForStretch(selectedStretch, 0, 0); // Always start with the first part for preview
                if (videoDetails.videoId) {
                    previewName.textContent = selectedStretch.name;
                    selectedModeDisplay.textContent = `Individual: ${selectedStretch.name}`;
                    
                    previewPlayerContainer.classList.remove('hidden');

                    if (isPreviewPlayerReady) {
                        previewPlayer.loadVideoById({ videoId: videoDetails.videoId, startSeconds: videoDetails.start });
                    }
                    updateVideoSelectionUI(videoSelectorPreview, selectedStretch, previewPlayer);
                    individualExercisePreview.classList.remove('hidden');
                } else {
                    // This case should ideally not happen if populateExerciseSelect filters correctly,
                    // but it's a good fallback for direct selection or other issues.
                    showCustomMessage(`"${selectedStretch.name}" does not have a verified video for preview. Please select another exercise or a routine mode.`);
                    individualExercisePreview.classList.add('hidden');
                    exerciseSelect.value = ""; // Reset dropdown if no video
                    IS_INDIVIDUAL_PREVIEW_MODE = false;
                    selectedModeDisplay.textContent = SELECTED_MODE;
                }
            }
        }

        function updateUIBasedOnMode() {
            if (SELECTED_MODE === 'Random') {
                individualExerciseSelectionContainer.classList.add('hidden');
                unverifiedExercisesListContainer.classList.add('hidden');
                individualExercisePreview.classList.add('hidden');
                if (isPreviewPlayerReady) previewPlayer.stopVideo();
                exerciseSelect.value = ""; // Clear selection if switching to random
            } else {
                individualExerciseSelectionContainer.classList.remove('hidden');
                // Visibility of unverifiedExercisesListContainer is managed by populateExerciseSelect
            }
            populateExerciseSelect(); // Repopulate and re-evaluate "fix" list visibility
        }
        
        function initializeApp() {
            const today = new Date();
            routineDateEl.textContent = `Your routine for ${today.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            
            selectedModeDisplay.textContent = SELECTED_MODE;
            currentSelectedModeText.textContent = SELECTED_MODE;

            initializeAppListeners();
            updateUIBasedOnMode(); // Initial UI setup based on default mode
        }

        function initializeAppListeners() {
            startBtn.addEventListener('click', startRoutine);
            pauseResumeBtn.addEventListener('click', togglePauseResume);
            endBtn.addEventListener('click', () => endRoutine(false));
            restartBtn.addEventListener('click', () => {
                completionScreen.classList.add('hidden');
                startRoutine();
            });

            modeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    SELECTED_MODE = e.target.dataset.mode;
                    selectedModeDisplay.textContent = SELECTED_MODE;
                    currentSelectedModeText.textContent = SELECTED_MODE;
                    exerciseSelect.value = ""; // Clear individual selection when mode changes
                    individualExercisePreview.classList.add('hidden');
                    IS_INDIVIDUAL_PREVIEW_MODE = false;
                    if (isPreviewPlayerReady) previewPlayer.stopVideo();
                    updateUIBasedOnMode(); // Update UI when mode changes
                });
            });

            exerciseSelect.addEventListener('change', (e) => {
                showIndividualExercisePreview(e.target.value);
                if (e.target.value) {
                    currentSelectedModeText.textContent = "Individual Exercise";
                } else {
                    currentSelectedModeText.textContent = SELECTED_MODE;
                }
            });
        }


        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
